# この一冊で全部わかるサーバーの基本


<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [この一冊で全部わかるサーバーの基本](#この一冊で全部わかるサーバーの基本)
  - [01 サーバーとは](#01-サーバーとは)
  - [02 ネットワークの基礎知識](#02-ネットワークの基礎知識)
  - [03 サーバーを用意する](#03-サーバーを用意する)
  - [04 社内サーバーの基本](#04-社内サーバーの基本)
  - [05 公開サーバーの基本](#05-公開サーバーの基本)
  - [06 サーバーを障害から守る](#06-サーバーを障害から守る)
  - [07 サーバーのセキュリティ](#07-サーバーのセキュリティ)
  - [08 サーバーの運用管理](#08-サーバーの運用管理)

<!-- /code_chunk_output -->

## 01 サーバーとは
- サーバー：クライアントにいろいろなサービスを提供するコンピュータのこと
  - クライアントの例：webブラウザ
- クライアントから要求されて初めて、サーバーは処理を開始し、サービスを提供する（レスポンスを返す）：**クライアント／サーバーシステム**
  - クライアントがサーバーに何かしらのサービスを要求する
    - WebブラウザがWebサーバーに「このサイトのデータをください」と要求する
  - サーバーは要求に応じた処理を行う
    - Webサーバーがそのサイトのファイルを見つけ出す
  - サーバーは処理結果をクライアントに返す
    - WebサーバーがそのファイルをWebブラウザに渡す
  - クライアントは処理結果を受け取る
    - Webブラウザがそのファイルを受け取り、画面に表示する
- サーバーを構築するには？
  - コンピュータにソフトウェアをインストールして、起動すればよい
    - サーバーは、サーバーソフトウェアが持つ機能のこと。つまり、そのソフトウェアをインストールすれば、サーバーを使えるようになる
  - 1台のコンピュータに複数のサーバーを入れることはもちろん可能
    - ただし、そのコンピュータが壊れると、入っている全てのサーバーに影響があるというリスクも伴うことは忘れずに
- サーバーの種類とサーバーソフトウェアの選び方
  - どのサーバーを用意するか？は「何をしたいか？」による
    - メールを受信したいのに、Webサーバーをたてても意味がない
  - サーバーソフトウェアの選択肢は限られており、どれを選ぶかの問題
    - 対応しているOS、プログラミング環境、要求されている機能、ランニングコストなど、いろんな要素を比較して決める
- 運用と管理
  - 設定を変更したい、という全ての要求を聞き入れるわけにはいかないので、設定する範囲を決めたドキュメントなどを残しておくと、管理がしやすくなる
  - 障害対応
    - 事前対応
      - 日々のモニタリング、脆弱性情報やバグのチェックなど
    - 事後対応
      - サーバーのどこにどんな障害が起きたのかをログなどで確認し、適切な対応を行う
- ネットワークとの関係
  - サーバーとクライアントをつなぐのがネットワーク
  - ここでいうネットワークは「コンピューターネットワーク」のこと
    - インターネットやLANが身近なコンピューターネットワーク

## 02 ネットワークの基礎知識
- サーバーを接続する、無線LANはクライアント側だけのもの
- OSI参照モデル
  - 7層のやつ
![OSI](./images/osi.png)
  - 通信機能の役割を階層的に分類した概念
  - 
  - 各階層の役割は異なる。互いの動作に影響を与えることがないし、トラブルシューティングもしやすい。
  - 各層から各層への通信にはそれぞれのプロトコルがある
    - イーサネット、Wi-Fiは物理層からデータリンク層、IPはネットワーク層、など
  - 送信は上から下、受信は下から上
    - 実際の通信は、NIC（Network Interface Card, ネットワークアダプタ）のデバイスドライバーやOS、アプリケーションが各層で使用するプロトコルを選んで処理するが、自動で行なわれるので、ユーザが意識することはない
- プロトコル
  - ネットワークの世界において、通信する時の約束事
    - httpsとかね
  - プロトコルは、パケット（送りたいデータを分割したもの）の送り先、順番を定義する
    - プロトコルの送り先は「ヘッダー」で見分ける
- イーサネット：物理層とデータリンク層で必要不可欠な規格
  - イーサネットフレームを作って、LANケーブルに流す電気信号や、光ファイバに流す光信号に変換してケーブルに流す
- MACアドレス：コンピュータを識別する
  - NICに自動で割り当てられる
  - 48ビットを8ビットずつ、ハイフンやコロンで区切って16進数で表記する
    - 上位24ビット：IEEEが機器のベンダーごとに割り当てたベンダーコード：OUI（Organizationally Unique Identifier）と呼ばれる
    - 下位24ビット：ベンダー内で機器ごとに割り当てている一意のコード
  - コンピュータがデータを送信するときは自分のMACアドレスを「送信元MACアドレス」に、データを送る相手のMACアドレスを「あて先MACアドレス」としてヘッダーに入れる
- スイッチング：スイッチの行なうフレーム転送
  - イーサネットは「スイッチ」を中心として、コンピュータを配置していく「スター型トポロジー」という形態でコンピュータ同士を接続している
  - MACアドレステーブル：スイッチがスイッチングで使用するインターフェイス番号と送信元MACアドレスのテーブル
    - イーサネットワークにおける通信効率の向上を図る
![ethernet](./images/ethernet.png)
- IPアドレス：ネットワーク層で最も重要なプロトコル
  - IP：トランスポート層から受け取ったデータにIPヘッダーをくっつけてIPパケットにする
  - IPアドレスでコンピュータを識別する
  - サブネットマスクとセットで使う
    - 10進数表記とCIDR表記
      - .で区切るやつと、IPアドレスの後ろにスラッシュとサブネットマスクの「1」の個数を付与するやつ
  - ネットワーク部とホスト部（サブネットマスクで分割される）
    - ネットワークそのものと、ネットワークに接続しているコンピュータそのもの
- ルーティング：IPパケットをバケツリレーして、データを目的地まで届けること
  - イーサネットで作ったネットワークとネットワークをつなぐときに使用するネットワーク機器が「ルーター」
  - たくさんのルーターが網目状にネットワークを繋ぐことで、インターネットが成り立っている
  - IPパケットの受け渡し先は「ルーティングテーブル」で管理する
    - 宛先ネットワークとネクストホップ（あて先ネットワークに対する、送り先のIPアドレス）
  - 静的ルーティングと動的ルーティング
    - ルーティングテーブルを手動で管理するか、隣接するルーター間でルート情報を交換（ルーティングプロトコルというプロトコルが定められている）して、自動的にルーティングテーブルを作る
    - 小規模なネットワーク、中・大規模なネットワーク
- ARP（Adress Resolution Protocol）：物理（MACアドレス）と論理（IPアドレス）を関連づける
  - あて先MACアドレスを判別するために使われる
  - データを送るコンピュータがネットワーク層からIPパケットを受け取ると、パケットのあて先IPアドレスを見る
  - あて先が同じネットワークにいるコンピュータであれば、そのIPアドレスをARPで問い合わせ（ARPリクエスト）
    - その応答結果（ARPリプライ）をARPテーブルに登録し、それをもとにイーサネットフレームを作る
  - 異なるネットワークのコンピュータの場合、デフォルトゲートウェイ（自分以外のネットワークに行くときに使用する出口のIPアドレス（≒経由先））のMACアドレスをARPで問い合わせ、↑と同じ処理を行う
- TCPとUDP
  - データを大事にしっかりやり取りしたい時はTCP（Transmission Control Protocol）
    - 「送ったよ」「届いたよ」をきちんと確認しあう
    - Web、メール、ファイル共有など
  - データの信頼性は横に置いておいて、とにかく早く送りたい時はUDP(User Datagram Protocol)
    - 送ったら送りっぱなし
    - IP電話、動画配信、時刻同期など
  - ポート番号を見て、コンピュータの中のどのサービスにデータを渡せば良いかを識別する
    - ウェルノウンポート：0~1023
      - 一般的なサーバーソフトウェアがクライアントのサービス要求を待ち受けるときに使う
    - レジスタードポート：1024~49151
      - メーカー独自のサーバーソフトウェアがクライアントのサービス要求を待ち受けるときに使う
    - ダイナミックポート：49152~65535
      - サーバーがクライアントソフトウェアを識別するために使う
- ポート番号
  - コンピューターの中で動作しているアプリケーションを識別するために使う数字
- NATとNAPT
  - プライベートIPアドレスをグローバルIPアドレスに変換する技術
  - NAT：ネットワークアドレス変換
    - IPアドレスを1対1で変換する
  - NAPT：ネットワークアドレスポート変換
    - IPアドレスとポート番号を変換する

## 03 サーバーを用意する
- サーバーの初期設定は、システム全体の未来を決めると言っても過言ではない
- ポイントは、どこにサーバーを設置するか、どんなsサーバーを設置するかの2つ
- オンプレミスとクラウド
  - オンプレミス：自社で保有する、カスタマイズはしやすく、トラブルシュートもしやすいが、ランニングコストがかかり、実稼働までの時間がかかる
  - クラウド：サーバーのスペックを臨機応変に変えやすい＝システムの変更要求に対応しやすい、サービス事業者の提供するものの範囲でしか利用できない
  - ハイブリッドクラウド：社内のオンプレとクラウド環境をVPNでつなぎ、2つのいいとこ取りをする
- クラウドサービスの種類
  - IaaS：Infrastrucute as a Service
    - CPU・メモリ、OSなどのインフラ部分を提供するタイプのクラウドサービス
    - EC2とか
    - システム管理者は、管理画面（コンソール）で、CPUの数やメモリの数、OSなどを選ぶ
    - 選んだら、OSだけがインストールされた空のコンピュータが提供され、必要なソフトウェアのインストールは自分たちで行なう
  - Paas：Platform as a Service
    - アプリケーションを実行するための環境（プラットフォーム）を提供するためのクラウドサービス
      - RDSとか
      - システム管理者は、管理画面で、使用したいプログラミング言語やデータベースの種類など、アプリケーション的な要素を選ぶ
        - 必要に応じて、インフラ的な要素も選ぶ
        - pythonのanaconda的な感じかな。あのイメージ。
      - 選んだら、指定したアプリケーションの実行環境が提供される
  - SaaS：Software as a Service
    - ソフトウェアを提供するタイプのクラウドサービス
    - ユーザは用意されたURLにアクセスし、Webブラウザからサービスを利用する
- 自社か、データセンターか
  - 設備、コスト、駆けつけ対応などで判断
  - 設備はデータセンターのほうがいい（プロなので）
  - コストは場合によりけり
    - データセンターは借りるので、レンタルするための諸々のお金がかかる
    - 自社はサーバールームの運用で実際にどれくらいかかるかを計算する
    - どっちがいいかで判断する
  - 自社のほうがすぐに駆けつけられる（それはそう）
    - データセンターにも都市型、郊外型がある
- サーバーを仮想化するか、しないか
  - 仮想化ソフトウェアを利用して、ハードウェアを仮想ハードウェアとして論理的に分割し、OSに割り当てる
  - 仮想化は管理面でのメリットが大きい
    - 設置スペースが増えるのを考えなくていいし、別のサーバーに仮想マシンを移動しやすいので
  - 一方で、パフォーマンスの劣化リスクがある
    - 仮想マシン自体を動かすのに色々な処理が走っているため
- ホストOS型：仮想化ソフトウェアがアプリケーションソフトウェアの1つとして動作する
  - 物理マシンのOSに仮想化ソフトウェアをインストールし、仮想マシンを動作させる
  - VirtualBoxとか
  - ホストOSにも影響があるので、それ自体のCPUやメモリを消費する
  - 検証環境には良いが、本番環境には向かない
- ハイパーバイザー型：OSとして動作する
  - サーバーに直接インストールした仮想化ソフトウェア上で、仮想マシンを動作させる
  - KVMとか
  - 全ての仮想マシンが「ハイパーバイザー」という制御プログラムの上で並列に動作する
  - 仮想化ソフトウェアだけを介してハードウェアを使えるので、ホストOS型よりも処理遅延が小さく、本番環境でもよく使われている
- サーバーをコンテナ化するか、しないか
  - 複数の仮想マシンが同じOSを使用する環境の場合、仮想マシンごとにOSを用意する必要があり、リソースが重複してしまう、という問題があった
  - それを解決するのがコンテナ
- サーバーの形状
  - オンプレ型の場合、どんなハードウェアでサーバーを構築するかも考える必要がある
  - タワー型
  - ラックマウント型
  - プレード型
- サーバーはどんなコンポーネントから構成されるのか
  - コンポーネントをパワーアップすることで、サーバー自体が強くなっていく
  - CPU
    - マルチコア化によって、処理能力を向上させられるようになった
  - メモリ
    - エラー自動訂正機構（ECC機構）、メモリミラーリング（冗長化）の機能がついており、信頼性向上につながっている
  - ストレージドライブ
    - RAIDによる冗長化
  - NIC
    - チーミングによる帯域の増、冗長化が進んでいる
- Linux系サーバーOSとWindows系サーバーOS
  - サーバーOS：サーバーとしてより安定的に動作するために開発・調整されたOSのこと
  - サーバーOSは2つしかない
  - Linux系はCLI（コマンドライン）操作が基本。オープンソース。
  - Windows系はGUI操作ができる。有償。
- アプライアンスサーバー
  - 特定のサービスや機能だけに特化して作られたサーバー
  - 導入・運用が簡単
    - サービスを提供するために必要なOSやサーバーソフトウェアがインストールされた状態で出荷されるため
  - マネージドな分、決められたことしかできない
- 仮想アプライアンスサーバー
  - 設置スペースが不要→コストの節約になる
  - 処理性能は物理サーバーより劣る
- 仮想化って流行っているんだなぁ 
  - 仮想化によって管理するサーバーの台数が増えたので、サーバーの構成管理ツールというものも普及した
    - ansibleが有名
## 04 社内サーバーの基本
## 05 公開サーバーの基本
## 06 サーバーを障害から守る
## 07 サーバーのセキュリティ
## 08 サーバーの運用管理