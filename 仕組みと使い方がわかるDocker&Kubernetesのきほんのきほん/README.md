# 仕組みと使い方がわかるDocker&Kubernetesのきほんのきほん


<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [仕組みと使い方がわかるDocker&Kubernetesのきほんのきほん](#仕組みと使い方がわかるdockerkubernetesのきほんのきほん)
  - [01 Dockerとは何だろう](#01-dockerとは何だろう)
    - [01 Dockerって何だろう](#01-dockerって何だろう)
    - [02 サーバとDocker](#02-サーバとdocker)
  - [02 Dockerが動く仕組み](#02-dockerが動く仕組み)
    - [01 Dockerが動く仕組み](#01-dockerが動く仕組み)
    - [02 Docker Hubとイメージとコンテナ](#02-docker-hubとイメージとコンテナ)
    - [03 Dockerコンテナのライフサイクルとデータの保存](#03-dockerコンテナのライフサイクルとデータの保存)
    - [04 Dockerのメリットとデメリット](#04-dockerのメリットとデメリット)

<!-- /code_chunk_output -->

## 01 Dockerとは何だろう

### 01 Dockerって何だろう
- 「データやプログラムを隔離できる」仕組みのこと
  - データ、プログラムだけでなく、OS（厳密にはOSではない）ごと隔離できる
- データやプログラムは「コンテナ」に入れることで独立できる
  - コンテナは物置みたいなもの
  - コンテナを使える仕組みがDocker
-  Dockerを動かすにはDocker Engineのインストールが必要
   -  コンテナでデータやプログラムを管理したい→Dockerが必要→Docker Engineが必要、という流れだと理解
-  コンテナはイメージから作る
   -  「〇〇のコンテナを作りたい」となったら「〇〇のイメージを使う」という流れになる、これはたぶんおまじない
   -  イメージはISOファイルに近い（CD、DVDをファイルに出力したもの。これがあれば元のCDやDVDを復元できる）。イメージがあればコンテナを復元できる、ということ
-  Dockerを動かすにはLinux OSが必要
-  データやプログラムを隔離したい理由
   -  プログラムは実行環境、ライブラリに依存して動いているため
   -  一部の都合で変更すると、他のものが動かなくなってしまう、ということがありうる
      -  サーバに何かのプログラムを同居させる場合、共有部分でトラブることがよくある
   -  この同居問題を解決してくれるのがDockerコンテナ

### 02 サーバとDocker
- サーバ…サービスを提供するもの
  - webサーバ：web機能を提供する
  - メールサーバ：メール機能を提供する
  - 複数の人がアクセスして使うのが、個人のノートPCと異なる
  - **サーバを作る＝あるソフトを入れて、その機能を持たせること**
- サーバには2種類ある
  - 機能としてのサーバ
    - webサーバ、メールサーバ、ファイルサーバ、etc...

サーバ | 特徴 
---------|----------
 webサーバ | webサイトの機能を提供するサーバ。HTMLファイル、画像ファイル、プログラムなどを置いておく。クライアントのブラウザがアクセスしてくると、それらのファイルを提供する
 メールサーバ | メールの送受信を担当するSMTPサーバと、クライアントにメールを受信させるPOPサーバの2つを合わせてメールサーバと呼ぶことが多い
 データベースサーバ | データを保存したり、検索したりするためのデータベースを置くサーバ。代表的なソフトはMySQL、PostgreSQLなど
 ファイルサーバ| ファイルを保存して、共有するサーバ
 DNSサーバ|IPアドレスと、ドメインを結びつけるDNS機能をもつサーバ
 DHCPサーバ|IPアドレスを自動的に振る機能を持つサーバ
 FTPサーバ|FTPプロトコルを使って、ファイルの送受信を行うサーバ。Webサーバと同居させることが多く、ファイルの設置に使う
 プロキシサーバ|通信を中継する役割を持つおサーバの総称。社内LANなど、インターネットから隔離された場所からインターネット上のサーバに接続するときに使う
 認証サーバ|ユーザを認証するためのサーバ。Windowsネットワークにログインするための「Active Directory」が有名

  - 物理的なマシンとしてのサーバ
    - EC2とかだよね、オンプレだと文字通り物理のサーバ、デスクトップのPCもそう
    - 機能としてのサーバを1つの物理的なマシンに複数同居させることが可能
- サーバのOSはLinuxが圧倒的優位
- コンテナを使えば、複数のサーバ機能を安全に同居させることができる
  - サーバマシン代の節約にもなる
- コンテナは持ち運べる
  - 同じ状態にチューニングしたコンテナを全員に配布し、開発環境をチームメンバ全員で統一するのも簡単
    - 各々にDockerが入っていさえすればいい
- Dockerは仮想化技術とイコールではない
  - 仮想化技術：VirtualBoxとか
    - 実質物理的なマシン、CPUとかも中身に含まれている
  - DockerはあくまでOSぽいものしかコンテナ上にない
    - OSの機能のいくつかは、ホストになっている（＝エンジンをインストールしている？）物理的なマシンに依存している
  - EC2も仮想化環境（VirtualBoxと同じ）。インスタンスはAMIというイメージから作るので、配布方法は似ている
- Dockerとホスティングサービス
  -  AWSのECSが有名どころ
  -  サーバを作ることなく、コンテナイメージを運用できる

## 02 Dockerが動く仕組み
### 01 Dockerが動く仕組み
- Dockerを使う時は、OSの上にDocker Engineを載せ、その上でコンテナを動かす
- コンテナの中に入っているのは「OSっぽいもの」
  - コンテナの初期状態は空っぽではなく、Linux OSぽいものが入った状態
    - 居酒屋で何も言わなくてもお通しが出てくるイメージ
  - OS：ソフトウェアなどプログラムの命令をハードウェアに伝える役割
    - 人間語を機械語に翻訳してくれるイメージ
    - カーネルとカーネルの周辺部分から構成されるのがOS
  - コンテナは完全に独立しているので、コンテナの中にあるプログラムの命令を土台（Docker Engineを入れているマシンのOS）がそのままでは受け取ることができない。受け取るために、コンテナの中にも専用のカーネル周辺部分を入れて、その子が土台のカーネルにコンテナ内部の命令を伝える役割を果たす。
    - コンテナ→Docker Engine→Linux OS→物理サーバ
      - コンテナのプログラムを物理サーバが実行するために、コンテナの初期状態としてカーネルの周辺部分がデフォルトで入っている
- DockerはLinux OSが土台であることが前提で成り立つ仕組み。コンテナの中に入れるソフトウェアもLinux用じゃないとだめ
  - Linuxはたいていサーバの文脈で出てくる→Dockerもサーバの文脈で話題に上がることが多い

### 02 Docker Hubとイメージとコンテナ
- イメージはコンテナの設計図
  - イメージからコンテナを作る
    - イメージは型。1つのイメージから複数のコンテナを生成できる
  - コンテナからもイメージを作成できる
    - 元のイメージの進化形を作れる
  - イメージ→コンテナの一方向しかない場合、複数コンテナを作った場合の改変が面倒（コンテナの数だけ作業が必要）
  - コンテナ→イメージの矢印があることで、イメージ1→コンテナ1→コンテナ1-1→イメージ1-1みたいなことができて、イメージ1-1から作ったコンテナ1-1をたくさん作れる
    - コンテナ→イメージの矢印がないと、イメージ1→コンテナ1→コンテナ1-1の作業をn回しないといけない
- イメージはDockerレジストリから入手するのが一般的（自作はしない）
  - Docker Hub, ECR, etc...
  - Docker HubはApple Storeみたいなもの、イメージがたくさん置いてある
  - イメージには、OSっぽいものが入っただけのものから複数のソフトウェアが入っているものまで、バラエティに富んでいる
- 1コンテナ1アプリ
  - セキュリティやメンテナンスのしやすさの観点から

### 03 Dockerコンテナのライフサイクルとデータの保存
- 基本は作っては捨てる
  - ×：1つのコンテナをアップデートしながら使い続ける
  - ○：アップデートされた新しいコンテナを使う
    - ＝新しいイメージを参照するようにする
  - 金継ぎではなく、スクラップアンドビルド
- コンテナのライフサイクル
  - 作る→起動する→停止する→破棄する→作る→・・・
- データの保存
  - コンテナは使ったら捨てるので、素直に考えればそのコンテナ内のデータも一緒に消えてなくなる
  - ので、Dockerをインストールしている物理的なマシン（土台）のディスクにマウントして、データを保存する
    - PCが壊れた時のために、ハードディスクにバックアップを取るのと同じイメージ

### 04 Dockerのメリットとデメリット
- メリット
  - 隔離できる
    - 独立している
    - イメージにできるので、レジストリから持ってくるだけでコンテナを使うことができる
      - イメージ化のその他のメリット：アップデートしやすい、入れ替えしやすい（イマイチと思ったら別のに乗り換えられる）、配布しやすい
    - コンテナに「カーネル」は不要
  - 1台の物理的なマシンに複数のサーバをのせられる
  - サーバの管理がしやすい
  - コマンド1つでサーバの構築ができる
- デメリット
  - コンテナの土台になっている物理的なマシンが死んだら、コンテナも死ぬ
- 使い道
  - 開発チームの環境を全員で揃えたい
  - 新バージョンを実験したい
  - 複数の同じサーバが必要になった